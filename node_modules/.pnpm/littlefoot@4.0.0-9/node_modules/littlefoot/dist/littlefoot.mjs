import{getStyle as t}from"@pacote/get-style";import{pixels as e}from"@pacote/pixels";import{throttle as o}from"@pacote/throttle";import{on as n,off as i}from"delegated-events";function r(t,e){t.classList.add(e)}function s(t,e){t.classList.remove(e)}function a(t){var e;null===(e=t.parentNode)||void 0===e||e.removeChild(t)}function l(t){const e=t.offsetHeight,o=t.getBoundingClientRect().top+e/2;return{above:o,below:window.innerHeight-o}}function c(e){const o=parseFloat(t(e,"marginLeft")),n=e.offsetWidth-o;return(e.getBoundingClientRect().left+n/2)/window.innerWidth}function d(e,o){const n=2*parseInt(t(e,"marginTop"),10)+e.offsetHeight;return o.below<n&&o.below<o.above?"above":"below"}const f=t=>!!t.parentElement;function u({id:o,button:n,content:i,host:u,popover:p,wrapper:m}){let v=!1,g=0,h="above";return{id:o,activate:o=>{var s;n.setAttribute("aria-expanded","true"),r(n,"is-changing"),r(n,"is-active"),n.insertAdjacentElement("afterend",p),p.style.maxWidth=document.body.clientWidth+"px",s=i,g=Math.round(e(t(s,"maxHeight"),s)),null==o||o(p,n)},dismiss:t=>{n.setAttribute("aria-expanded","false"),r(n,"is-changing"),s(n,"is-active"),s(p,"is-active"),null==t||t(p,n)},isActive:()=>n.classList.contains("is-active"),isReady:()=>!n.classList.contains("is-changing"),isHovered:()=>v,ready:()=>{r(p,"is-active"),s(n,"is-changing")},remove:()=>{a(p),s(n,"is-changing")},reposition:()=>{f(p)&&(i.style.maxHeight=function(e,o,n){const i=l(o),r=d(e,i),s=parseInt(t(e,"marginTop"),10);return Math.min(n,i[r]-s-15)}(p,n,g)+"px",h=function(t,e,o){const n=d(t,l(e));if(o!==n){s(t,"is-"+o),r(t,"is-"+n);const i=100*c(e)+"%",a="above"===n?"100%":"0";t.style.transformOrigin=i+" "+a}return n}(p,n,h),p.offsetHeight<i.scrollHeight?(r(p,"is-scrollable"),i.setAttribute("tabindex","0")):(s(p,"is-scrollable"),i.removeAttribute("tabindex")))},resize:()=>{f(p)&&(p.style.left=function(e,o){const n=e.offsetWidth;return-c(o)*n+parseInt(t(o,"marginLeft"),10)+o.offsetWidth/2}(i,n)+"px",m.style.maxWidth=i.offsetWidth+"px",function(t,e){const o=t.querySelector(".littlefoot__tooltip");o&&(o.style.left=100*c(e)+"%")}(p,n))},startHovering:()=>{v=!0},stopHovering:()=>{v=!1},destroy:()=>a(u)}}function p(t,e){t.addEventListener("wheel",o((t=>e=>{const o=e.currentTarget,n=-e.deltaY;n>0&&s(t,"is-fully-scrolled"),o&&n<=0&&n<o.clientHeight+o.scrollTop-o.scrollHeight&&r(t,"is-fully-scrolled")})(e),16))}const m=t=>r(t,"littlefoot--print");function v(t,e){return Array.from(t.querySelectorAll(e))}function g(t,e){return t.querySelector("."+e)||t.firstElementChild||t}function h(t){const e=document.createElement("div");return e.innerHTML=t,e.firstElementChild}function b(t){return void 0!==t}function y(t){const e=t.parentElement,o=function(t,e){return Array.from(t.children).filter((t=>8!==t.nodeType&&t.matches(e)))}(e,":not(.littlefoot--print)"),n=o.filter((t=>"HR"===t.tagName));o.length===n.length&&(n.concat(e).forEach(m),y(e))}function w(t){const e=t.parentElement;a(t);e.innerHTML.replace("[]","").replace("&nbsp;"," ").trim()||w(e)}function A(t,e){const o=h(t.body.outerHTML);v(o,'[href$="#'+t.referenceId+'"]').forEach(w);const n=o.innerHTML.trim();return{original:t,data:{id:String(e+1),number:e+1,reference:"lf-"+t.referenceId,content:n.startsWith("<")?n:"<p>"+n+"</p>"}}}function E(t){const e=/<%=?\s*(\w+?)\s*%>/g;return o=>t.replace(e,((t,e)=>{var n;return String(null!==(n=o[e])&&void 0!==n?n:"")}))}function H({allowDuplicates:t,anchorParentSelector:e,anchorPattern:o,buttonTemplate:n,contentTemplate:i,footnoteSelector:r,numberResetSelector:a,scope:l}){const c=function(t,e,o){return v(t,o+' a[href*="#"]').filter((t=>(t.href+t.rel).match(e)))}(document,o,l).map(function(t,e,o,n){const i=[];return r=>{const s=r.href.split("#")[1],a=v(t,"#"+window.CSS.escape(s)).find((t=>e||!i.includes(t))),l=null==a?void 0:a.closest(n);if(l){i.push(l);const t=r.closest(o)||r;return{reference:t,referenceId:t.id||r.id,body:l}}}}(document,t,e,r)).filter(b).map(A).map(a?(t=>{let e=0,o=null;return({original:n,data:i})=>{const r=n.reference.closest(t);return e=o===r?e+1:1,o=r,{original:n,data:Object.assign(Object.assign({},i),{number:e})}}})(a):t=>t).map(function(t,e){const o=E(t),n=E(e);return({original:t,data:e})=>{const i=e.id,r=h(`<span class="littlefoot">${o(e)}</span>`),s=r.firstElementChild;s.setAttribute("aria-expanded","false"),s.dataset.footnoteButton="",s.dataset.footnoteId=i;const a=h(n(e));a.dataset.footnotePopover="",a.dataset.footnoteId=i;const l=g(a,"littlefoot__wrapper"),c=g(a,"littlefoot__content");return p(c,a),{original:t,data:e,id:i,button:s,host:r,popover:a,content:c,wrapper:l}}}(n,i)).map((t=>(m(t.original.reference),m(t.original.body),y(t.original.body),t.original.reference.insertAdjacentElement("beforebegin",t.host),t))).map(u);return{footnotes:c,unmount(){c.forEach((t=>t.destroy())),v(document,".littlefoot--print").forEach((t=>s(t,"littlefoot--print")))}}}const x={activateDelay:100,activateOnHover:!1,allowDuplicates:!0,allowMultiple:!1,anchorParentSelector:"sup",anchorPattern:/(fn|footnote|note)[:\-_\d]/gi,dismissDelay:100,dismissOnUnhover:!1,footnoteSelector:"li",hoverDelay:250,numberResetSelector:"",scope:"",contentTemplate:'<aside class="littlefoot__popover" id="fncontent:<% id %>"><div class="littlefoot__wrapper"><div class="littlefoot__content"><% content %></div></div><div class="littlefoot__tooltip"></div></aside>',buttonTemplate:'<button class="littlefoot__button" id="<% reference %>" title="See Footnote <% number %>"><svg role="img" aria-labelledby="title-<% reference %>" viewbox="0 0 31 6" preserveAspectRatio="xMidYMid"><title id="title-<% reference %>">Footnote <% number %></title><circle r="3" cx="3" cy="3" fill="white"></circle><circle r="3" cx="15" cy="3" fill="white"></circle><circle r="3" cx="27" cy="3" fill="white"></circle></svg></button>'};const _=(t,e)=>t.target.closest(e),S=t=>null==t?void 0:t.dataset.footnoteId,T=t=>e=>{e.preventDefault();const o=_(e,"[data-footnote-id]"),n=S(o);n&&t(n)},D=document.addEventListener,L=window.addEventListener;function C(t){const e=new AbortController,{signal:r}=e,s=(a=t.toggle,l=t.dismissAll,t=>{const e=_(t,"[data-footnote-button]"),o=S(e);o?a(o):_(t,"[data-footnote-popover]")||l()});var a,l;const c=(d=t.dismissAll,t=>{27!==t.keyCode&&"Escape"!==t.key&&"Esc"!==t.key||d()});var d;const f=o(t.repositionAll,16),u=o(t.resizeAll,16),p=T(t.hover),m=T(t.unhover);return D("touchend",s,{signal:r}),D("click",s,{signal:r}),D("keyup",c,{signal:r}),D("gestureend",f,{signal:r}),L("scroll",f,{signal:r}),L("resize",u,{signal:r}),n("mouseover","[data-footnote-id]",p),n("mouseout","[data-footnote-id]",m),()=>{e.abort(),i("mouseover","[data-footnote-id]",p),i("mouseout","[data-footnote-id]",m)}}function M(t={}){const e=Object.assign(Object.assign({},x),t),o=function({footnotes:t,unmount:e},o){const n=t=>e=>{e.isReady()&&(e.dismiss(o.dismissCallback),setTimeout(e.remove,t))},i=e=>i=>{o.allowMultiple||t.filter((t=>t.id!==i.id)).forEach(n(o.dismissDelay)),i.isReady()&&(i.activate(o.activateCallback),i.reposition(),i.resize(),setTimeout(i.ready,e))},r=e=>o=>{const n=t.find((t=>t.id===o));n&&e(n)};return{activate:(t,e)=>r(i(e))(t),dismiss:(t,e)=>r(n(e))(t),dismissAll:()=>t.forEach(n(o.dismissDelay)),repositionAll:()=>t.forEach((t=>t.reposition())),resizeAll:()=>t.forEach((t=>t.resize())),toggle:r((t=>t.isActive()?n(o.dismissDelay)(t):i(o.activateDelay)(t))),hover:r((t=>{t.startHovering(),o.activateOnHover&&!t.isActive()&&i(o.hoverDelay)(t)})),unhover:r((e=>{e.stopHovering(),o.dismissOnUnhover&&setTimeout((()=>t.filter((t=>!t.isHovered())).forEach(n(o.dismissDelay))),o.hoverDelay)})),unmount:e}}(H(e),e),n=C(o);return{activate(t,n=e.activateDelay){o.activate(t,n)},dismiss(t,n=e.dismissDelay){void 0===t?o.dismissAll():o.dismiss(t,n)},unmount(){n(),o.unmount()},getSetting:t=>e[t],updateSetting(t,o){e[t]=o}}}export{M as default,M as littlefoot};
